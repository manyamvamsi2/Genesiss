{% extends "base.html" %}

{% block content %}
<div class="card">
    <h2 class="section-header">Simulation Results</h2>

    <div class="grid-container">
        <div class="metric-card">
            <div class="metric-value">{{ analysis.total_transactions|default(0)|int|format_number }}</div>
            <div class="metric-label">Total Transactions</div>
        </div>

        {% if analysis.fraud_count is defined %}
        <div class="metric-card">
            <div class="metric-value">{{ analysis.fraud_count|default(0)|int|format_number }}</div>
            <div class="metric-label">Fraudulent</div>
        </div>
        {% endif %}

        {% if analysis.total_amount is defined %}
        <div class="metric-card">
            <div class="metric-value">${{ analysis.total_amount|default(0)|float|format_currency }}</div>
            <div class="metric-label">Total Amount</div>
        </div>
        {% endif %}

        {% if analysis.avg_transaction is defined %}
        <div class="metric-card">
            <div class="metric-value">${{ analysis.avg_transaction|default(0)|float|format_currency }}</div>
            <div class="metric-label">Avg. Transaction</div>
        </div>
        {% endif %}
    </div>
</div>

{% if analysis.category_distribution is defined %}
<div class="chart-container">
    <h3 class="section-header">Transaction Type Distribution</h3>
    <div id="category-distribution-chart">
        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px;">
            {% for category, count in analysis.category_distribution.items() %}
            <div style="display: flex; align-items: center; margin-bottom: 5px;">
                <div style="width: 15px; height: 15px; background-color: {{ get_random_color() }}; margin-right: 5px; border-radius: 3px;"></div>
                <span>{{ category }}: {{ count }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

{% if analysis.fraud_by_category is defined %}
<div class="chart-container">
    <h3 class="section-header">Fraud Analysis</h3>
    <div id="fraud-by-category-chart">
        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
            {% set max_fraud = analysis.fraud_by_category.values()|max %}
            {% for category, count in analysis.fraud_by_category.items() %}
            <div style="display: flex; align-items: center;">
                <div style="width: 120px; margin-right: 10px;">{{ category }}</div>
                <div style="height: 20px; background-color: {{ get_random_color() }}; width: {{ (count / max_fraud) * 100 }}%; border-radius: 3px; display: flex; align-items: center; justify-content: flex-end; padding-right: 5px; color: white; font-size: 12px;">
                    {{ count }}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

{% if analysis.risk_patterns is defined %}
<div class="card">
    <h3 class="section-header">Risk Patterns Detected</h3>
    <div id="risk-patterns">
        {% for pattern, count in analysis.risk_patterns.items() %}
        <div class="risk-pattern">
            <span>{{ pattern|replace('_', ' ')|title }}</span>
            <span class="risk-count">{{ count }}</span>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="card">
    <h3 class="section-header">Sample Transactions</h3>
    <table class="table">
        <thead>
            <tr>
                {% if sample_data and sample_data[0] %}
                    {% for column in sample_data[0].keys() %}
                        <th>{{ column|replace('_', ' ')|title }}</th>
                    {% endfor %}
                {% else %}
                    <th>No Data</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% if sample_data %}
                {% for row in sample_data %}
                <tr>
                    {% for value in row.values() %}
                    <td>{{ value }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            {% else %}
                <tr><td colspan="100%">No sample data available.</td></tr>
            {% endif %}
        </tbody>
    </table>

    <div class="download-options">
        <a href="/download/csv" class="btn btn-success">Download CSV</a>
        <a href="/download/json" class="btn btn-success">Download JSON</a>
    </div>
</div>

<div style="margin-top: 20px; text-align: center;">
    <a href="{{ url_for('index') }}" class="btn btn-primary">Generate New Dataset</a>
</div>
{% endblock %}
